local Players = game:GetService("Players")
local player = Players.LocalPlayer
local ToggleESPEvent = game.ReplicatedStorage:WaitForChild("ToggleESPEvent")

local espEnabled = false
local espObjects = {} -- เก็บ ESP ที่ถูกสร้าง

-- ฟังก์ชันสร้าง ESP ให้ผู้เล่นอื่น
local function createESP(target)
    if target.Character and target.Character:FindFirstChild("Head") then
        
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "ESP_Tag"
        billboard.Adornee = target.Character.Head
        billboard.Size = UDim2.new(0, 200, 0, 50)
        billboard.AlwaysOnTop = true
        
        local label = Instance.new("TextLabel", billboard)
        label.Size = UDim2.new(1, 0, 1, 0)
        label.BackgroundTransparency = 1
        label.Text = target.Name
        label.TextColor3 = Color3.fromRGB(255, 50, 50)
        label.TextScaled = true
        
        billboard.Parent = target.Character
        
        espObjects[target] = billboard
    end
end

-- ลบ ESP
local function removeESP(target)
    if espObjects[target] then
        espObjects[target]:Destroy()
        espObjects[target] = nil
    end
end

-- เปิด/ปิด ESP
ToggleESPEvent.OnClientEvent:Connect(function(state)
    espEnabled = state

    for _, p in pairs(Players:GetPlayers()) do
        if p ~= player then
            if espEnabled then
                createESP(p)
            else
                removeESP(p)
            end
        end
    end
end)

-- ถ้ามีผู้เล่นเข้ามาใหม่ขณะเปิด ESP
Players.PlayerAdded:Connect(function(p)
    if espEnabled then
        p.CharacterAdded:Connect(function()
            createESP(p)
        end)
    end
end)
